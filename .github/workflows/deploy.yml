name: Deploy EventPass Backend (EC2 Runner)

on:
  push:
    branches:
      - main   

jobs:
  deploy:
    runs-on: [self-hosted, backend]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up environment file
        run: |
          cat > /var/www/eventpass-backend/.env <<EOF
          MONGO_URI=${{ secrets.MONGO_URI }}
          EMAIL_HOST=${{ secrets.EMAIL_HOST }}
          EMAIL_PORT=${{ secrets.EMAIL_PORT }}
          EMAIL_USER=${{ secrets.EMAIL_USER }}
          EMAIL_PASS=${{ secrets.EMAIL_PASS }}
          EMAIL_FROM=${{ secrets.EMAIL_FROM }}
          ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
          MASTER_KEY=${{ secrets.MASTER_KEY }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_ACCESS_EXPIRY=${{ secrets.JWT_ACCESS_EXPIRY }}
          JWT_REFRESH_EXPIRY=${{ secrets.JWT_REFRESH_EXPIRY }}
          CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}
          CLOUDINARY_FOLDER=${{ secrets.CLOUDINARY_FOLDER }}
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET=${{ secrets.S3_BUCKET }}
          CLOUDFRONT_URL=${{ secrets.CLOUDFRONT_URL }}
          GOOGLE_API_URL=${{ secrets.GOOGLE_API_URL }}
          GOOGLE_TRANSLATE_API_KEY=${{ secrets.GOOGLE_TRANSLATE_API_KEY }}
          FRONTEND_BASE_URL=${{ secrets.FRONTEND_BASE_URL }}
          SURVEYGURU_PUBLIC_PATH=${{ secrets.SURVEYGURU_PUBLIC_PATH }}
          NODE_ENV=${{ secrets.NODE_ENV }}
          PORT=${{ secrets.PORT }}
          EOF

      - name: Deploy application
        run: |
          cd /var/www/eventpass-backend
          rm -rf * .[^.]*
          cp -r $GITHUB_WORKSPACE/* .
          npm install --omit=dev
          pm2 restart eventpass-backend || pm2 start npm --name "eventpass-backend" -- run start
          pm2 save
