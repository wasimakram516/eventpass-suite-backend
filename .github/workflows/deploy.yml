name: Deploy EventPass Backend (EC2 Runner)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted, backend]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare deployment directory
        run: |
          sudo mkdir -p /var/www/eventpass-backend
          sudo chown -R ubuntu:ubuntu /var/www/eventpass-backend
          cd /var/www/eventpass-backend
          rm -rf * .[^.]* || true
          cp -r $GITHUB_WORKSPACE/* .

      - name: Create .env file
        run: |
          cd /var/www/eventpass-backend
          sudo rm -f .env
          sudo touch .env
          echo "MONGO_URI='${{ secrets.MONGO_URI }}'" | sudo tee -a .env
          echo "EMAIL_HOST='${{ secrets.EMAIL_HOST }}'" | sudo tee -a .env
          echo "EMAIL_PORT='${{ secrets.EMAIL_PORT }}'" | sudo tee -a .env
          echo "EMAIL_USER='${{ secrets.EMAIL_USER }}'" | sudo tee -a .env
          echo "EMAIL_PASS='${{ secrets.EMAIL_PASS }}'" | sudo tee -a .env
          echo "EMAIL_FROM='${{ secrets.EMAIL_FROM }}'" | sudo tee -a .env
          echo "ADMIN_EMAIL='${{ secrets.ADMIN_EMAIL }}'" | sudo tee -a .env
          echo "ADMIN_PASSWORD='${{ secrets.ADMIN_PASSWORD }}'" | sudo tee -a .env
          echo "MASTER_KEY='${{ secrets.MASTER_KEY }}'" | sudo tee -a .env
          echo "JWT_SECRET='${{ secrets.JWT_SECRET }}'" | sudo tee -a .env
          echo "JWT_ACCESS_EXPIRY='${{ secrets.JWT_ACCESS_EXPIRY }}'" | sudo tee -a .env
          echo "JWT_REFRESH_EXPIRY='${{ secrets.JWT_REFRESH_EXPIRY }}'" | sudo tee -a .env
          echo "CLOUDINARY_CLOUD_NAME='${{ secrets.CLOUDINARY_CLOUD_NAME }}'" | sudo tee -a .env
          echo "CLOUDINARY_API_KEY='${{ secrets.CLOUDINARY_API_KEY }}'" | sudo tee -a .env
          echo "CLOUDINARY_API_SECRET='${{ secrets.CLOUDINARY_API_SECRET }}'" | sudo tee -a .env
          echo "CLOUDINARY_FOLDER='${{ secrets.CLOUDINARY_FOLDER }}'" | sudo tee -a .env
          echo "AWS_REGION='${{ secrets.AWS_REGION }}'" | sudo tee -a .env
          echo "AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}'" | sudo tee -a .env
          echo "AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}'" | sudo tee -a .env
          echo "S3_BUCKET='${{ secrets.S3_BUCKET }}'" | sudo tee -a .env
          echo "CLOUDFRONT_URL='${{ secrets.CLOUDFRONT_URL }}'" | sudo tee -a .env
          echo "GOOGLE_API_URL='${{ secrets.GOOGLE_API_URL }}'" | sudo tee -a .env
          echo "GOOGLE_TRANSLATE_API_KEY='${{ secrets.GOOGLE_TRANSLATE_API_KEY }}'" | sudo tee -a .env
          echo "FRONTEND_BASE_URL='${{ secrets.FRONTEND_BASE_URL }}'" | sudo tee -a .env
          echo "SURVEYGURU_PUBLIC_PATH='${{ secrets.SURVEYGURU_PUBLIC_PATH }}'" | sudo tee -a .env
          echo "WHATSAPP_BASE_URL='${{ secrets.WHATSAPP_BASE_URL }}'" | sudo tee -a .env
          echo "WHATSAPP_ACCOUNT_SSID='${{ secrets.WHATSAPP_ACCOUNT_SSID }}'" | sudo tee -a .env
          echo "WHATSAPP_USERNAME='${{ secrets.WHATSAPP_USERNAME }}'" | sudo tee -a .env
          echo "WHATSAPP_PASSWORD='${{ secrets.WHATSAPP_PASSWORD }}'" | sudo tee -a .env
          echo "WHATSAPP_FROM='${{ secrets.WHATSAPP_FROM }}'" | sudo tee -a .env
          echo "CHECKIN_WHATSAPP_SSID='${{ secrets.CHECKIN_WHATSAPP_SSID }}'" | sudo tee -a .env
          echo "EVENTREG_WHATSAPP_SSID='${{ secrets.EVENTREG_WHATSAPP_SSID }}'" | sudo tee -a .env
          echo "NODE_ENV='production'" | sudo tee -a .env
          echo "PORT='8080'" | sudo tee -a .env
          echo ".env file created successfully"

      - name: Install and restart PM2 app
        run: |
          cd /var/www/eventpass-backend
          npm install --omit=dev
          pm2 restart eventpass-backend || pm2 start npm --name "eventpass-backend" -- run start
          pm2 save
